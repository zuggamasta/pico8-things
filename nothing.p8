pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
n = 0

px = 64
py = 64
dx = 0
dy = 0
max_dx =4


background_x = 0

jumping = false
falling = false
ground_level = 96

-- fixed values
jump_legnth = 0
jump_length_init = 6
player_width = 8


function _init()
	jump_legnth = jump_length_init

	poke(0x5f38, 2)
	poke(0x5f39, 2)
end


function _update()
	if(btn(4)) then
		_update = _gameupdate
		_draw = _gamedraw
	end
	
end

function _gameupdate()
	n+=1
	playerUpdate()
end



function playerUpdate()

	if (btnp(2) and (not jumping) and (not falling)) then
		jumping = true
	end

	if(not jumping and py < ground_level) then
		falling = true
	end

	if(falling) then
		dy +=1 
	end

	if(jumping) then 
		dy -= 1
		jump_legnth -= 1
	end

	if(jump_legnth <= 0) then
		jumping = false
		jump_legnth = jump_length_init
	end
	
	if(py >= ground_level and not jumping) then
		falling = false
		dy = 0
		py = ground_level
	end

	py +=dy
	
	if (py > ground_level) then py = ground_level end


	if(btn(1)) then
		dx+=1
		background_x -= 1/5
	end

	if(btn(0)) then
		dx-=1
		background_x += 1/5
	end

	if(dx >= max_dx ) then dx = max_dx end
	if(dx <= -max_dx) then dx = -max_dx end

	if(not jumping) then 
		dx = dx/1.33
	end

	px += dx

	if(px >= 128 ) then 
		px = 128 
		dx = 0
	end

	if(px <= 0 ) then 
		px = 0 
		dx = 0
	end

end


function _draw()
	
	cls(7)
	-- debug infos 
	print(py, 1 ,1,7)
	if(jumping) then print("jumping",1,8,7) end
	print(stat(1),1,15,7)
	
end

function _gamedraw()
	cls(7)

	rectfill(0,0,128,64,12)
	
	drawmapnew( dx/20,1,(time()*2)%4,0)

	draw_horizont()

	d_player()
	
end

function draw_horizont()
	spr(64,0+background_x,49,16,2)
end

--draw world
function drawmapnew(cx,cy,cz,angle)
	
	local a= angle
	local ca,sa= cos(a),-sin(a)
	for ye=65,127 do
		--coords in world space
		local rz=(cy*64)/(ye-64)
		-- ground height
		local rx=rz*(0-64)/64
		local x,z =
		ca*rx+sa*rz+cx,
		-sa*rx+ca*rz+cz
		tline(0,ye,256,ye,
		-- u and v coordinates
		x,z,
		-- delta u and delta v coordinates
		ca*rz/64,-sa*rz/64)
	end
end

--draw player
function d_player()

	-- render floor shadow
	if(py>92) then
		spr(7,px-player_width,106,2,1,true)
	else
		spr(23,px-player_width,107,2,1,true)
	end

	-- render tail
	spr(flr((n/10)%2)+9,px+1,py+2,1,1,false)

	-- render ears
	spr(flr((n/20)%2)+11,px-5,py-1,1,1,false)

	-- contour
	if(flr((n/6)%2)>0) then
		--draw 2x2 sprite block
		spr(
			flr((n/3)%2)*2+36
			,px-player_width+1,py+1,2,2,false)	
	else
		--draw 2x2 sprite block mirrored
		spr(
			flr((n/3)%2)*2+36
			,px-player_width+1,py+1,2,2,true)
	end

	--flip sprite every x frames
	if(flr((n/6)%2)>0) then
		--draw 2x2 sprite block
		spr(
			flr((n/3)%2)*2
			,px-player_width,py,2,2,false)	
	else
		--draw 2x2 sprite block mirrored
		spr(
			flr((n/3)%2)*2
			,px-player_width,py,2,2,true)
	end

	
end


function d_world(offset, width, center, tiles)
	--calculate repeating world y position, added offset param for seamless loop
	
	world_y = n%64 + 64 - offset


	--draw map via tline() from top to bottom
	for i = 0, 512 do 
		 
		x0t = 0
		y0t = world_y+i
		x1t = 128
		y1t = world_y+i
		mx = 0
		my = i/ tiles
		newwidth = width + i +world_y

		mxd = tiles/newwidth
		myd = 0
		tline(x0t,y0t,x1t,y1t,mx,my,mxd,myd)
	end
end
	

__gfx__
00000000000000000000001111000000999999993333333355555555000000000000000000000000000000000000000000001001000000000000000000000000
000001111000000000000199991000009ffff9993bbbb33355555555000000000000000000011000000000000000100100011011000000000000000000000000
000019999100000000001999999100009fff99f93bbb33b355555555000000000000000000111100000011000001101100011111000000000000000000000000
000199999910000000019991199910009ff99ff93bb33bb355555555000005555550000000111100000111100001111100011111000000000000000000000000
001999119991000000019910019910009f99fff93b33bbb355555555005555555555550001111000001111100001111100000000000000000000000000000000
00199100199100000001991000110000999ffff9333bbbb355555555055555555555555011111000011111000000000000000000000000000000000000000000
0001100019910000000199910000000099fffff933bbbbb355555555005555555555550011110000111110000000000000000000000000000000000000000000
00000001999100000000199910000000999999993333333355555555000005555550000011000000111000000000000000000000000000000000000000000000
00000019991000000000019991000000111111112222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
000001999100000000000199910000001cccc1112888822200000000000000000000000000000000000000000000000000000000000000000000000000000000
000001999100000000000011100000001ccc11c12888228200000000000000000000000000000000000000000000000000000000000000000000000000000000
000000111000000000000000000000001cc11cc12882288200000000000000000000000000000000000000000000000000000000000000000000000000000000
000000111000000000000011100000001c11ccc12822888200000000000055555555000000000000000000000000000000000000000000000000000000000000
00000199910000000000019991000000111cccc12228888200000000005555555555550000000000000000000000000000000000000000000000000000000000
0000019991000000000001999100000011ccccc12288888200000000000055555555000000000000000000000000000000000000000000000000000000000000
00000011100000000000001110000000111111112222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
00000033330000000000003333000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000
00000333333000000000033333300000000001111000000000000111111000000000000000000000000000000000000000000000000000000000000000000000
00000333333000000000033333300000000011111100000000001111111100000000000000000000000000000000000000000000000000000000000000000000
00000333333000000000033333300000000111111110000000011111111110000000000000000000000000000000000000000000000000000000000000000000
0000003bb30bb0000000003bb3000000001111111111000000011110011110000000000000000000000000000000000000000000000000000000000000000000
0000b3bbbb3bb0000000b3bbbb3b0000001111001111000000011110001100000000000000000000000000000000000000000000000000000000000000000000
000bb3bbbb3b0000000bb3bbbb3bb000000110001111000000011111000000000000000000000000000000000000000000000000000000000000000000000000
00bb003330000000000f0033300f0000000000011111000000001111100000000000000000000000000000000000000000000000000000000000000000000000
0fb00bbbbbb0000000000bbbbbb00000000000111110000000000111110000000000000000000000000000000000000000000000000000000000000000000000
00000bbbbbb0000000000bbbbbbb0000000001111100000000000111110000000000000000000000000000000000000000000000000000000000000000000000
0000bbb0bbb000000000bbb00bbb0000000001111100000000000011100000000000000000000000000000000000000000000000000000000000000000000000
0000bbb0bbb000000000bbb000300000000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000330b33000000000033000330000000000111000000000000011100000000000000000000000000000000000000000000000000000000000000000000000
000033300bb000000000033000000000000001111100000000000111110000000000000000000000000000000000000000000000000000000000000000000000
00003300000000000000330000000000000001111100000000000111110000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000111000000000000011100000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044444000000
00000000000000000004999400000000000000000000000000133300000000000000000000000000000000000000000000000000000000000000499999444000
000000000000000000049994000000000000000000000000031bbb30000000000000000000000000000000000000000000000000000000000000499999999440
0000000000000000004999940000000000000000000000033bbbbbb3000000000000000000000000000000000000000000000000000000000000499999999994
00000000000000000049999940000000000000000000013bbbbbbbbb300000000000000000000000000000000000000000000000000000000000444449449940
0000000000000000049999994000003303000000000001bbbbbbbbb1b30000000000000000000000000000000000000000000000000000000004999999999400
000000000004400049999449400003bb3b30000000003bb1bbbbbbb1b30000000000000000000000000000000000000000000000000000000004999999999440
000000000049940049444999400003bbbbb3000000003bb1bbbbbbbbbb3000331300000000000000000000000000000000000000000000000000499994449940
000000000499994499999999940003bbbbb300000003bbbbbbbb1bbbbbb033bb1b33000000000000000000000000000000000000000000000000499499999400
000000044999999944999999994003bbbbb300000003bbbbbbbb1bbbbbb3bbbbbbbb300000000000000000000000033300000000000000000000499999994000
00004449999999999949999999403bbbbbb30000003bbbbbbbbbbbbbbbb3b1bbbbbb3000000000000000000000003bbb30000000000000000004999999940000
00049999999999999994499999403bbbbbb30000003bbbbbb1bbbbbbbbbbb1bbbbb1b30000000000000000000003bbbb33330000000000000049999999940000
00499933339994449999949999403bbbbb30000003bb1bbbb1bbbbbbbbbbbbbbbbb1b30000000000000000000003bbb3bbbb3000000000000049944999994000
049443bbbb39999999999999999403bbbb30044003bb1bbbbbbbbbbb1bbbbbbbbbbbbb300000000000000000003bbb3bbbbbb300000000000049999999999400
499993bbbbb39999999999944494003bb30049943bbbbbbbbbbbbbbb1bbbbbbbb1bbbb300000000000000000003bbbbbbbbbb300000000000004999994499400
499993bbbbb39999999999999999403bb30499943bbbbb1bbbbbbbbbbbbbbbbbb1bbbbb30000000000000000003bbbbbbbbbbb30000000000000499999999400
00000000000000000000044444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000499999444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000499999999440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000499999999994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000444449449940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000004999999999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000004999999999440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000499994449940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000499499999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000333000000000000499999994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00003bbb300000000004999999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0003bbbb333300000049999999940000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0003bbb3bbbb30000049944999994000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
003bbb3bbbbbb3000049999999999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
003bbbbbbbbbb3000004999994499400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
003bbbbbbbbbbb300000499999999400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000007777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000077777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000007777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000077777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000077777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000007777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777777777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777775777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777777777777777777577777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777777777777577777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777777777777577777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777577777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777775777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000
00077777777777777777757777777777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000
00000077777777777755577777777777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000777755577777777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
